<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메뉴 관리</title>
    <link rel="stylesheet" href="server_Design.css">
</head>
<body>
    <h1>메뉴 관리 시스템</h1>
    <!-- 메뉴 추가 버튼 -->
    <button onclick="showAddMenuForm()">메뉴 추가</button>
    <!-- 메뉴 목록 표시 -->
    <div id="menu-list">
        <table id="menu-table">
            <thead>
                <tr>
                    <th>
                        <button onclick="sortMenu('id')">ID</button> <!-- ID 정렬 가능 -->
                    </th>
                    <th>
                        <select id="category-filter" onchange="filterByCategory()">
                            <option value="">카테고리</option>
                            <option value="한식">한식</option>
                            <option value="분식">분식</option>
                            <option value="양식">양식</option>
                            <option value="Special">Special</option>
                        </select>
                    </th>
                    <th>메뉴명</th>
                    <th>
                        <button onclick="sortMenu('price')">가격</button> <!-- 가격 정렬 가능 -->
                    </th>
                    <th>이미지</th>
                    <th>수정</th>
                    <th>삭제</th>
                </tr>
            </thead>            
            <tbody>
                <!-- 메뉴 항목은 여기에 동적으로 추가됩니다 -->
            </tbody>
        </table>
    </div>

    <!-- 메뉴 추가 팝업 -->
    <div id="add-form" class="popup">
        <div id="add-popup-content">
            <h2>메뉴 추가</h2>
            <label>카테고리: 
                <select id="menu-category">
                    <option value="한식">한식</option>
                    <option value="분식">분식</option>
                    <option value="양식">양식</option>
                    <option value="Special">Special</option>
                </select>
            </label><br>
            <label>메뉴명: <input type="text" id="menu-name"></label><br>
            <label>가격: <input type="number" id="menu-price"></label><br>
            <label>이미지: <input type="file" id="menu-image"></label><br>
            <button onclick="addMenu()">추가</button>
            <button onclick="closeAddMenuForm()">취소</button>
        </div>
    </div>

    <!-- 메뉴 수정 팝업 -->
    <div id="update-form" class="popup">
        <div id="update-popup-content">
          <h2>메뉴 수정</h2>
          <label>ID: <input type="text" id="update-menu-id" readonly/></label><br>
          <label>카테고리: 
                <select id="update-menu-category">
                    <option value="한식">한식</option>
                    <option value="분식">분식</option>
                    <option value="양식">양식</option>
                    <option value="Special">Special</option>
                </select>
            </label><br>
          <label>메뉴명: <input type="text" id="update-menu-name"></label><br>
          <label>가격: <input type="number" id="update-menu-price"></label><br>
          <label>이미지: <input type="file" id="update-menu-image"></label><br>
          <button onclick="updateMenu()">수정</button>
          <button onclick="closeUpdateMenuForm()">취소</button>
        </div>
    </div>

    <script>
        let currentSortColumn = '';
        let currentSortOrder = 'asc';

        // 메뉴 데이터를 서버에서 가져오는 함수
        function fetchMenu() {
            fetch('http://localhost:8000/menu')
                .then(response => response.json())
                .then(data => {
                    displayMenu(data);
                })
                .catch(error => {
                    alert('메뉴를 불러오는 데 실패했습니다: ' + error);
                });
        }

        // 메뉴 데이터 표시 및 정렬/필터링
        function displayMenu(data) {
            const categoryFilter = document.getElementById('category-filter').value;
            const menuContainer = document.getElementById('menu-table').getElementsByTagName('tbody')[0];
            menuContainer.innerHTML = '';

            data = data.filter(item => categoryFilter === '전체' || categoryFilter === '' || item.category === categoryFilter);

            if (currentSortColumn) {
                data.sort((a, b) => {
                    let valueA = a[currentSortColumn];
                    let valueB = b[currentSortColumn];
                    if (currentSortColumn === 'price' || currentSortColumn === 'id') {
                        valueA = parseFloat(valueA);
                        valueB = parseFloat(valueB);
                    }
                    if (currentSortOrder === 'asc') return valueA > valueB ? 1 : -1;
                    else return valueA < valueB ? 1 : -1;
                });
            }

            data.forEach(item => {
                const safeName = item.name.replace(/'/g, "\\'");
                const safeCategory = item.category.replace(/'/g, "\\'");
                const safeImage = item.image || '';
                const menuRow = document.createElement('tr');
                menuRow.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.category}</td>
                    <td>${item.name}</td>
                    <td>${item.price}원</td>
                    <td>${item.image ? `<img src="${item.image}" alt="${item.name}" style="width:100px; height:auto;">` : ''}</td>
                    <td><button onclick="prepareUpdateMenu(${item.id}, '${safeName}', ${item.price}, '${safeImage}', '${safeCategory}')">수정</button></td>
                    <td><button onclick="deleteMenu(${item.id})">삭제</button></td>
                `;
                menuContainer.appendChild(menuRow);
            });
        }

        function filterByCategory() {
            fetchMenu();
        }

        function sortMenu(column) {
            if (currentSortColumn !== column) {
                // 새 열을 선택하면 오름차순으로 시작
                currentSortOrder = 'asc';
            } else {
                // 같은 열을 다시 클릭하면 정렬 방향을 변경
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            }
            currentSortColumn = column;
            fetchMenu();
        }

        // 메뉴 추가 함수
        function addMenu() {
            // 입력된 값 가져오기
            const category = document.getElementById('menu-category').value;
            const name = document.getElementById('menu-name').value;
            const price = document.getElementById('menu-price').value;
            const image = document.getElementById('menu-image').files[0]; // 이미지 파일

            // 필수 입력 값 체크
            if (!category || !name || !price) {
                alert('모든 필드를 입력해주세요.');
                return;
            }

            // 폼 데이터 구성 (이미지 파일 포함)
            const formData = new FormData();
            formData.append('category', category);
            formData.append('name', name);
            formData.append('price', price);
            if (image) {
                formData.append('image', image);
            }

            // 서버로 메뉴 추가 요청 보내기
            fetch('http://localhost:8000/menu', {
                method: 'POST',
                body: formData // FormData는 자동으로 적절한 Content-Type을 설정합니다.
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    alert('메뉴가 성공적으로 추가되었습니다.');
                    closeAddMenuForm();  // 추가 폼 닫기
                    fetchMenu();  // 메뉴 목록 다시 불러오기
                } else {
                    alert('메뉴 추가에 실패했습니다.');
                }
            })
            .catch(error => {
                alert('메뉴 추가 중 오류가 발생했습니다: ' + error);
            });
        }

        // 수정할 메뉴를 준비하는 함수
        function prepareUpdateMenu(id, name, price, image, category) {
            // 수정 폼의 각 필드에 기존 값들을 넣음
            document.getElementById('update-menu-id').value = id;
            document.getElementById('update-menu-name').value = name;
            document.getElementById('update-menu-price').value = price;
            document.getElementById('update-menu-category').value = category;
            document.getElementById('update-menu-image').value = ''; // 새 이미지는 선택 안함

            // 수정 폼 열기
            showUpdateMenuForm();
        }

        // 메뉴 수정 함수
        function updateMenu() {
            const id = document.getElementById('update-menu-id').value;
            const name = document.getElementById('update-menu-name').value;
            const price = document.getElementById('update-menu-price').value;
            const category = document.getElementById('update-menu-category').value;
            const image = document.getElementById('update-menu-image').files[0]; // 새 이미지 파일

            // FormData 객체 생성 (파일을 포함한 폼 데이터 전송을 위해)
            const formData = new FormData();
            formData.append('id', id);
            formData.append('name', name);
            formData.append('price', price);
            formData.append('category', category);
            if (image) {
                formData.append('image', image);  // 새 이미지가 선택되었을 경우
            }

            // 서버에 수정 요청 보내기
            fetch('http://localhost:8000/menu/update', {
                method: 'POST',
                body: formData  // FormData로 데이터를 전송
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('메뉴가 수정되었습니다.');
                    closeUpdateMenuForm();  // 수정 폼 닫기
                    fetchMenu();  // 메뉴 목록 새로고침
                } else {
                    alert('메뉴 수정에 실패했습니다.');
                }
            })
            .catch(error => {
                alert('메뉴 수정 중 오류가 발생했습니다: ' + error);
            });
        }

        // 메뉴 삭제 함수
        function deleteMenu(id) {
            if (!confirm('정말로 이 메뉴를 삭제하시겠습니까?')) {
                return;  // 사용자가 취소한 경우 삭제하지 않음
            }

            // 삭제할 메뉴의 ID를 서버에 전달하여 삭제 요청
            fetch('http://localhost:8000/menu', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',  // JSON 형식으로 요청 본문을 보냄
                },
                body: JSON.stringify({ id: id })  // 삭제할 메뉴 ID 포함
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('메뉴가 삭제되었습니다.');
                    fetchMenu();  // 메뉴 목록 새로고침
                } else {
                    alert('메뉴 삭제에 실패했습니다.');
                }
            })
            .catch(error => {
                alert('메뉴 삭제 중 오류가 발생했습니다: ' + error);
            });
        }

        // 메뉴 추가 폼을 표시
        function showAddMenuForm() {
            document.getElementById('add-form').style.display = 'block';  // 추가 폼을 표시
        }

        // 메뉴 추가 폼을 숨기기
        function closeAddMenuForm() {
            document.getElementById('add-form').style.display = 'none';  // 추가 폼을 숨기기
        }

        // 메뉴 수정 폼을 표시
        function showUpdateMenuForm() {
            document.getElementById('update-form').style.display = 'block';  // 수정 폼을 표시
        }

        // 메뉴 수정 폼을 숨기기
        function closeUpdateMenuForm() {
            document.getElementById('update-form').style.display = 'none';  // 수정 폼을 숨기기
        }

        // 페이지 로드 시 메뉴 목록 가져오기
        window.onload = fetchMenu;
    </script>
</body>
</html>
